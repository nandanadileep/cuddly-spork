// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String               @id @default(cuid())
  email             String               @unique
  name              String?
  password_hash     String?
  openai_credits       Int                  @default(100)
  target_role          String?
  job_description_jsonb Json?                // full job description for analysis
  created_at           DateTime             @default(now())
  updated_at        DateTime             @updatedAt
  
  platformConnections PlatformConnection[]
  projects            Project[]
  resumes             Resume[]
  
  @@map("users")
}

model PlatformConnection {
  id                      String    @id @default(cuid())
  user_id                 String
  platform                String    // 'github', 'gitlab', 'behance', etc.
  username                String?
  access_token_encrypted  String?   @db.Text
  refresh_token_encrypted String?   @db.Text
  last_synced             DateTime?
  metadata_jsonb          Json?     // platform-specific data
  created_at              DateTime  @default(now())
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, platform])
  @@map("platform_connections")
}

model Project {
  id                String    @id @default(cuid())
  user_id           String
  platform          String
  external_id       String
  name              String
  description       String?   @db.Text
  url               String
  technologies_jsonb Json?    // array of tech stack
  ai_score          Int?      // 0-100
  ai_analysis_jsonb Json?     // detailed AI analysis
  analyzed_for_role String?   // which role was used for analysis
  stars             Int?
  forks             Int?
  language          String?
  is_selected       Boolean   @default(false)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, platform, external_id])
  @@index([user_id, ai_score])
  @@map("projects")
}

model Resume {
  id                      String    @id @default(cuid())
  user_id                 String
  title                   String
  target_role             String?
  template_id             String    @default("modern")
  latex_content           String    @db.Text
  pdf_url                 String?
  selected_projects_jsonb Json?     // array of project IDs
  skills_jsonb            Json?     // extracted skills
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id, created_at])
  @@map("resumes")
}
