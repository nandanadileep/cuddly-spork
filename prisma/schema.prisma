// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String               @id @default(cuid())
  email             String               @unique
  name              String?
  password_hash     String?
  password_reset_token String?            @db.Text
  password_reset_expires DateTime?
  openai_credits       Int                  @default(100)
  target_role          String?
  linkedin_url         String?              // manual entry linkedin url
  phone               String?
  location            String?
  website             String?
  onboarding_completed Boolean              @default(false)
  job_description_jsonb Json?                // full job description for analysis
  created_at           DateTime             @default(now())
  updated_at        DateTime             @updatedAt
  
  platformConnections PlatformConnection[]
  projects            Project[]
  resumes             Resume[]
  education           Education[]
  workExperience      WorkExperience[]
  analysisDraft       AnalysisDraft?
  extracurriculars    Extracurricular[]
  awards              Award[]
  publications        Publication[]
  
  @@map("users")
}

model PlatformConnection {
  id                      String    @id @default(cuid())
  user_id                 String
  platform                String    // 'github', 'gitlab', 'behance', etc.
  username                String?
  access_token_encrypted  String?   @db.Text
  refresh_token_encrypted String?   @db.Text
  last_synced             DateTime?
  metadata_jsonb          Json?     // platform-specific data
  created_at              DateTime  @default(now())
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, platform])
  @@map("platform_connections")
}

model Project {
  id                String    @id @default(cuid())
  user_id           String
  platform          String
  external_id       String
  name              String
  description       String?   @db.Text
  url               String
  technologies_jsonb Json?    // array of tech stack
  ai_score          Int?      // 0-100
  ai_analysis_jsonb Json?     // detailed AI analysis
  analyzed_for_role String?   // which role was used for analysis
  stars             Int?
  forks             Int?
  language          String?
  is_selected       Boolean   @default(false)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, platform, external_id])
  @@index([user_id, ai_score])
  @@map("projects")
}


model Resume {
  id                      String    @id @default(cuid())
  user_id                 String
  title                   String
  target_role             String?
  template_id             String    @default("modern")
  latex_content           String    @db.Text
  pdf_url                 String?
  selected_projects_jsonb Json?     // array of project IDs
  skills_jsonb            Json?     // extracted skills
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id, created_at])
  @@map("resumes")
}

model Education {
  id           String    @id @default(cuid())
  user_id      String
  institution  String
  degree       String
  field        String?
  cgpa         String?
  location     String?
  start_date   DateTime?
  end_date     DateTime?
  is_current   Boolean   @default(false)
  description  String?   @db.Text
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("education")
}

model WorkExperience {
  id           String    @id @default(cuid())
  user_id      String
  company      String
  position     String
  location     String?
  start_date   DateTime?
  end_date     DateTime?
  is_current   Boolean   @default(false)
  description  String?   @db.Text
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("work_experience")
}

model Extracurricular {
  id           String    @id @default(cuid())
  user_id      String
  title        String
  organization String?
  location     String?
  start_date   DateTime?
  end_date     DateTime?
  is_current   Boolean   @default(false)
  description  String?   @db.Text
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("extracurriculars")
}

model Award {
  id           String    @id @default(cuid())
  user_id      String
  title        String
  issuer       String?
  awarded_at   DateTime?
  description  String?   @db.Text
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("awards")
}

model Publication {
  id           String    @id @default(cuid())
  user_id      String
  title        String
  venue        String?
  published_at DateTime?
  url          String?
  description  String?   @db.Text
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("publications")
}

model AnalysisDraft {
  id                         String   @id @default(cuid())
  user_id                    String   @unique
  selected_project_ids_jsonb Json?
  manual_projects_jsonb      Json?
  project_bullets_jsonb      Json?
  skills_jsonb               Json?
  manual_skills_jsonb        Json?
  excluded_skills_jsonb      Json?
  template_id                String   @default("modern")
  created_at                 DateTime @default(now())
  updated_at                 DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("analysis_drafts")
}
